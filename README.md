# Описание

Данная система предназначена для полуавтоматического развертывания серверов, выполняющих роли Frontend и Backend, и содержащих комплекс соответствующих служб и конфигураций.

В данной статье описывается вариант установки Frontend и Backend на единственный хост, выполняющий обе роли, однако, система также подойдет и для варианта развертывания вышеуказанных ролей на отдельных хостах, так как для развертывания используется подключение к хостам по протоколу SSH (в данном варианте подключение для развертывания будет осуществляться с того же хоста, на котором будут развернуты Frontend и Backend, поэтому IP-адресами Frontend и Backend будет являться адрес localhost - 127.0.0.1).

В данном примере используются 2 Backend-службы: service-a и service-b. В качестве менеджера развертывания системы используется Ansible.

В качестве платформы для тестирования системы использовался контейнер LXC "almalinux-8_amd64", развернутый в системе виртуализации Proxmox 7.3_1.


# Описание файлов конфигураций, скриптов и т.д.


## Ansible

**ansible.cfg** - конфигурация Ansible в пределах данного проекта

**inventory** - файл, содержащий информацию об управляемых хостах, в том числе адреса хостов и настройки для подключения к ним

**frontend_deploy.yml** - сценарий для развертывания Frontend

**backend_*.yml** - сценарии для развертывания/удаления служб Backend


## Frontend

**frontend/backup.sh** - скрипт бэкапирования директорий и файлов, необходимых для восстановления системы

**frontend/http.conf** - конфигурация nginx для редиректа запросов с HTTP на HTTPS

**frontend/monitor.service** - конфигурация systemd для мониторинга служб Backend

**frontend/monitor.sh** - скрипт для службы мониторинга

**frontend/nginx.conf** - основная конфигурация Nginx


## Backend


### Service-A

**backend/service-a/app.py** - приложение python

**backend/service-a/requirements.txt** - модули python VENV, необходимые для работы python-приложения

**backend/service-a/service-a.example.com.conf** - конфигурация nginx для проксирования на порт службы service-a

**backend/service-a/service-a.service** - конфигурация systemd для работы службы service-a


### Service-B

**backend/service-b/service-b.example.com/index.php** - приложение PHP

**backend/service-b/service-b.conf** - конфигурация nginx для службы PHP service-b

**backend/service-b/service-b.example.com.conf** - конфигурация nginx для проксирования на порт службы service-b


# Развертывание системы


## Необходимые предварительные настройки и условия

- Физическая или виртуальная машина (или контейнер) с установленной ОС семейства RHEL (Almalinux 8) в свежей минимальной установке для развертывания системы. Для работы системы необходимо выполнить начальную настройку сети с доступом во внешнюю сеть.
- Добавленные A-записи на DNS-сервере для соответствия доменных имен Backend-служб IP-адресу сервера Backend. Клиентская машина должна иметь возможность разрешать используемые доменные имена служб в IP-адреса. Для каждой новой добавленной службы Backend-хоста необходимо добавлять соответствующую запись. Сделать это можно разными способами. Самы простой способ - прописать на клиентской машине IP-адрес основного DNS-сервера.

Пример (DNS-сервер на Mikrotik RouterOS):

```
/ip dns static
add address=192.168.111.140 name=service-a.example.com
add address=192.168.111.140 name=service-b.example.com
```


## Начальная настройка хоста Frontend-Backend

Установка необходимых компонентов для запуска развертывания системы

```
dnf install -y git ansible-core openssh-server
```

Запуск службы SSHD

```
systemctl enable --now sshd
```

Теперь можно подключиться к хосту по протоколу SSH

Клонируем репозиторий системы в локальную директорию

```
git clone https://github.com/clesssalvein/frontend-backend-test.git
```

Переходим в локальную директорию репозитория

```
cd frontend-backend-test
```


### Развертывание Frontend

Правим необходимые переменные в следующих файлах: **inventory**,**/opt/backup-script/backup.sh**,**/opt/monitor/monitor.sh**.

Инициируем запуск развертывания Frontend. Сценарий содержит заголовки с описанием каждого действия развертывания.

```
ansible-playbook -v -i inventory frontend_deploy.yml
```

В результате, помимо прочего, мы получим:

- Сетевой экран, фильтрующий всё, кроме определенных запросов. В нашем случае открыты порты 22,80,443/tcp для подключения по SSH (в реальном развертывании необходимо открывать порт 22 только определенным IP-адресам или диапазонам IP-адресов) и к веб-серверу по портам 80,443 соответственно. Текущую конфигурацию сетевого экрана можно посмотреть при помощи следующей команды консоли:

```
iptables -L -v -n
```

- Настроенную службу Nginx, принимающую соединения на порт 443 (соответствующие самоподписанные сертификаты создаются в соответствии со сценариями для каждой службы Backend) распределяющему соединения в соответствии с доменными именами служб. Конфигурации для распределения соединения для каждой службы Backend находятся в директории **/etc/nginx/backend.d/**.

- Службу мониторинга **monitor.service**, через определенный промежуток времени проверяющую состояние открытых портов каждой службы Backend. Служба записывает логи и статус запущенных служб в соответствующие субдиректории в базовой директории **/opt/monitor/**. Скрипт получает имя и порт службы автоматически из файлов конфигурации, находящихся в директории **/etc/nginx/backend.d/**. В случае падения и восстановления служб, в качестве примера, в скрипте добавлена логика оповещения через Telegram-бот (для этого предварительно необходимо создать Telegram-бота, добавить его в соответствующую группу Telegram и отредактировать соответствующий chat_id параметр в скрипте мониторинга). Подробно о работе службы мониторинга можно узнать из комментариев в скрипте **/opt/monitor/monitor.sh**.

- Скрипт бэкапирования **/opt/backup-script/backup.sh**. Добавленно задание CRON на запуск скрипта раз в сутки. Скрипт бэкапирует указанные в его переменных директории раз в сутки, удаляя при этом старые бэкапы, оставляя только новые за определенный в скрипте период. Также бэкапирование инициируется в соответствующую директорию каждое первое число каждого месяца. Подробнее о работе бэкапирования можно узнать из комментариев скрипта.


### Развертывание Backend-службы Service-A

Инициируем запуск развертывания Backend-службы Service-A

```
ansible-playbook -v -i inventory backend_service-a_deploy.yml
```

В результате, мы получим службу приложения Python Flask API, работающую на порте 8080/tcp. Служба Frontend Nginx проксирует порт 443/tcp на порт данной службы. Данные приложения размещены по пути **/opt/service-a/**. Получить доступ к приложению можно по ссылке:

```
https://service-a.example.com/
```

Удаление Backend-службы Service-A

```
ansible-playbook -v -i inventory backend_service-a_remove.yml
```


### Развертывание Backend-службы Service-B

Инициируем запуск развертывания Backend-службы Service-B

```
ansible-playbook -v -i inventory backend_service-b_deploy.yml
```

В результате, мы получим службу приложения PHP, работающую на базе службы Nginx и на порте 8081/tcp. Служба Frontend Nginx проксирует порт 443/tcp на порт данной службы. Данные приложения и службы размещены по следующим путям **/usr/share/nginx/html/service-b.example.com**,**/etc/nginx/conf.d/service-b.conf**. Получить доступ к приложению можно по ссылке:

```
https://service-b.example.com/
```

Удаление Backend-службы Service-B

```
ansible-playbook -v -i inventory backend_service-b_remove.yml
```
